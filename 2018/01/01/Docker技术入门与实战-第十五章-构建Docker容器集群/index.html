<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>Docker技术入门与实战-第十五章 构建Docker容器集群 | Quincey | mind in mind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Docker">
    <meta name="description" content="Docker的网络模式概述自从docker容器出现以来，容器的网络通信就一直是大家关注的焦点，也是生产环境的迫切需求。而容器的网络通信又可以分为两大方面：单主机容器上的相互通信和跨主机的容器相互通信。而本文将分别针对这两方面，对容器的通信原理进行简单的分析。 docker单主机容器通信基于对net namespace的控制，docker可以为在容器创建隔离的网络环境，在隔离的网络环境下，容器具有完">
<meta name="keywords" content="Docker">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker技术入门与实战-第十五章 构建Docker容器集群">
<meta property="og:url" content="http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/index.html">
<meta property="og:site_name" content="Quincey">
<meta property="og:description" content="Docker的网络模式概述自从docker容器出现以来，容器的网络通信就一直是大家关注的焦点，也是生产环境的迫切需求。而容器的网络通信又可以分为两大方面：单主机容器上的相互通信和跨主机的容器相互通信。而本文将分别针对这两方面，对容器的通信原理进行简单的分析。 docker单主机容器通信基于对net namespace的控制，docker可以为在容器创建隔离的网络环境，在隔离的网络环境下，容器具有完">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://cdn.docker.matlabchina.cn/Docker-ch15.0-1.jpg">
<meta property="og:image" content="http://cdn.docker.matlabchina.cn/Docker-ch15.0-2.jpg">
<meta property="og:image" content="http://cdn.docker.matlabchina.cn/Docker-ch15.0-3.jpg">
<meta property="og:image" content="http://cdn.docker.matlabchina.cn/Docker-ch15.1-1.jpg">
<meta property="og:image" content="http://cdn.docker.matlabchina.cn/Docker-ch15.2-1.PNG">
<meta property="og:updated_time" content="2018-01-01T12:41:59.260Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Docker技术入门与实战-第十五章 构建Docker容器集群">
<meta name="twitter:description" content="Docker的网络模式概述自从docker容器出现以来，容器的网络通信就一直是大家关注的焦点，也是生产环境的迫切需求。而容器的网络通信又可以分为两大方面：单主机容器上的相互通信和跨主机的容器相互通信。而本文将分别针对这两方面，对容器的通信原理进行简单的分析。 docker单主机容器通信基于对net namespace的控制，docker可以为在容器创建隔离的网络环境，在隔离的网络环境下，容器具有完">
<meta name="twitter:image" content="http://cdn.docker.matlabchina.cn/Docker-ch15.0-1.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="Quincey" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/logo.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Quincey Svng</h5>
          <a href="mailto:salsa2010@foxmail.com" title="salsa2010@foxmail.com" class="mail">salsa2010@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Quincey Svng
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/SuperFireFoxy" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/salsa2010" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://www.facebook.com/felix.song.79" target="_blank" >
                <i class="icon icon-lg icon-link"></i>
                facebook
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Docker技术入门与实战-第十五章 构建Docker容器集群</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Docker技术入门与实战-第十五章 构建Docker容器集群</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-01-01T07:29:45.000Z" itemprop="datePublished" class="page-time">
  2018-01-01
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Docker/">Docker</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Docker的网络模式"><span class="post-toc-number">1.</span> <span class="post-toc-text">Docker的网络模式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#概述"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">概述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#docker单主机容器通信"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">docker单主机容器通信</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#host模式"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">host模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#bridge模式"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">bridge模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#none模式"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">none模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#其他容器模式"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">其他容器模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#用户定义网络模式"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">用户定义网络模式</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#docker跨主机容器通信"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">docker跨主机容器通信</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#15-1-使用自定义网桥连接跨主机容器"><span class="post-toc-number">2.</span> <span class="post-toc-text">15.1 使用自定义网桥连接跨主机容器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#15-2-使用Ambassador容器"><span class="post-toc-number">3.</span> <span class="post-toc-text">15.2 使用Ambassador容器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基本场景"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">基本场景</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#15-3-本章小结"><span class="post-toc-number">4.</span> <span class="post-toc-text">15.3 本章小结</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-Docker技术入门与实战-第十五章-构建Docker容器集群"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Docker技术入门与实战-第十五章 构建Docker容器集群</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-01-01 15:29:45" datetime="2018-01-01T07:29:45.000Z"  itemprop="datePublished">2018-01-01</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Docker/">Docker</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="Docker的网络模式"><a href="#Docker的网络模式" class="headerlink" title="Docker的网络模式"></a>Docker的网络模式</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>自从docker容器出现以来，容器的网络通信就一直是大家关注的焦点，也是生产环境的迫切需求。而容器的网络通信又可以分为两大方面：单主机容器上的相互通信和跨主机的容器相互通信。而本文将分别针对这两方面，对容器的通信原理进行简单的分析。</p>
<h3 id="docker单主机容器通信"><a href="#docker单主机容器通信" class="headerlink" title="docker单主机容器通信"></a>docker单主机容器通信</h3><p>基于对net namespace的控制，docker可以为在容器创建隔离的网络环境，在隔离的网络环境下，容器具有完全独立的网络栈，与宿主机隔离，也可以使容器共享主机或者其他容器的网络命名空间，基本可以满足开发者在各种场景下的需要。按docker官方的说法，docker容器的网络有五种模式：</p>
<ul>
<li>bridge：docker默认的网络模式，为容器创建独立的网络命名空间，容器具有独立的网卡等所有单独的网络栈，是最常用的使用方式。  </li>
<li>host：直接使用容器宿主机的网络命名空间。  </li>
<li>none：为容器创建独立网络命名空间，但不为它做任何网络配置，容器中只有lo，用户可以在此基础上，对容器网络做任意定制。  </li>
<li>其他容器：与host模式类似，只是容器将与指定的容器共享网络命名空间。  </li>
<li>用户自定义：docker 1.9版本以后新增的特性，允许容器使用第三方的网络实现或者创建单独的bridge网络，提供网络隔离能力。</li>
</ul>
<p>这些网络模式在相互网络通信方面的对比如下所示：</p>
<p>模式</p>
<p>是否支持多主机    南北向通信机制<br>东西向通信机制</p>
<p>bridge    否    宿主机端口绑定    通过Linux bridge<br>host    是    按宿主机网络通信    按宿主机网络通信<br>none    否    无法通信    只能用link通信<br>其他容器    否    宿主机端口绑定    通过link通信<br>用户自定义    按网络实现而定    按网络实现而定    按网络实现而定<br>南北向通信指容器与宿主机外界的访问机制，东西向流量指同一宿主机上与其他容器相互访问的机制。</p>
<h4 id="host模式"><a href="#host模式" class="headerlink" title="host模式"></a>host模式</h4><p>由于容器和宿主机共享同一个网络命名空间，换言之，容器的IP地址即为宿主机的IP地址。所以容器可以和宿主机一样，使用宿主机的任意网卡，实现和外界的通信。其网络模型可以参照下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://cdn.docker.matlabchina.cn/Docker-ch15.0-1.jpg" alt="ch15.0-1" title="">
                </div>
                <div class="image-caption">ch15.0-1</div>
            </figure>
<p>采用host模式的容器，可以直接使用宿主机的IP地址与外界进行通信，若宿主机具有公有IP，那么容器也拥有这个公有IP。同时容器内服务的端口也可以使用宿主机的端口，无需额外进行NAT转换，而且由于容器通信时，不再需要通过linuxbridge等方式转发或者数据包的拆封，性能上有很大优势。当然，这种模式有优势，也就有劣势，主要包括以下几个方面：</p>
<p>最明显的就是容器不再拥有隔离、独立的网络栈。容器会与宿主机竞争网络栈的使用，并且容器的崩溃就可能导致宿主机崩溃，在生产环境中，这种问题可能是不被允许的。<br>容器内部将不再拥有所有的端口资源，因为一些端口已经被宿主机服务、bridge模式的容器端口绑定等其他服务占用掉了。</p>
<h4 id="bridge模式"><a href="#bridge模式" class="headerlink" title="bridge模式"></a>bridge模式</h4><p>bridge模式是docker默认的，也是开发者最常使用的网络模式。在这种模式下，docker为容器创建独立的网络栈，保证容器内的进程使用独立的网络环境，实现容器之间、容器与宿主机之间的网络栈隔离。同时，通过宿主机上的docker0网桥，容器可以与宿主机乃至外界进行网络通信。其网络模型可以参考下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://cdn.docker.matlabchina.cn/Docker-ch15.0-2.jpg" alt="ch15.0-2" title="">
                </div>
                <div class="image-caption">ch15.0-2</div>
            </figure>
<p>从该网络模型可以看出，容器从原理上是可以与宿主机乃至外界的其他机器通信的。同一宿主机上，容器之间都是连接到docker0这个网桥上的，它可以作为虚拟交换机使容器可以相互通信。然而，由于宿主机的IP地址与容器veth pair的 IP地址均不在同一个网段，故仅仅依靠veth pair和namespace的技术，还不足以使宿主机以外的网络主动发现容器的存在。为了使外界可以方位容器中的进程，docker采用了端口绑定的方式，也就是通过iptables的NAT，将宿主机上的端口端口流量转发到容器内的端口上。</p>
<p>举一个简单的例子，使用下面的命令创建容器，并将宿主机的3306端口绑定到容器的3306端口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -tid –name db -p 3306:3306 MySQL</span><br></pre></td></tr></table></figure></p>
<p>在宿主机上，可以通过<code>iptables -t nat -L -n</code>，查到一条DNAT规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DNAT tcp — 0.0.0.0/0 0.0.0.0/0 tcp dpt:3306 to:172.17.0.5:3306</span><br></pre></td></tr></table></figure></p>
<p>上面的172.17.0.5即为bridge模式下，创建的容器IP。</p>
<p>很明显，bridge模式的容器与外界通信时，必定会占用宿主机上的端口，从而与宿主机竞争端口资源，对宿主机端口的管理会是一个比较大的问题。同时，由于容器与外界通信是基于三层上iptables NAT，性能和效率上的损耗是可以预见的。</p>
<h4 id="none模式"><a href="#none模式" class="headerlink" title="none模式"></a>none模式</h4><p>在这种模式下，容器有独立的网络栈，但不包含任何网络配置，只具有lo这个loopback网卡用于进程通信。也就是说，none模式为容器做了最少的网络设置，但是俗话说得好“少即是多”，在没有网络配置的情况下，通过第三方工具或者手工的方式，开发这任意定制容器的网络，提供了最高的灵活性。</p>
<h4 id="其他容器模式"><a href="#其他容器模式" class="headerlink" title="其他容器模式"></a>其他容器模式</h4><p>其他网络模式是docker中一种较为特别的网络的模式。在这个模式下的容器，会使用其他容器的网络命名空间，其网络隔离性会处于bridge桥接模式与host模式之间。当容器共享其他容器的网络命名空间，则在这两个容器之间不存在网络隔离，而她们又与宿主机以及除此之外其他的容器存在网络隔离。其网络模型可以参考下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://cdn.docker.matlabchina.cn/Docker-ch15.0-3.jpg" alt="ch15.0-3" title="">
                </div>
                <div class="image-caption">ch15.0-3</div>
            </figure>
<p>在这种模式下的容器可以通过localhost来同一网络命名空间下的其他容器，传输效率较高。而且这种模式还节约了一定数量的网络资源，但它并没有改变容器与外界通信的方式。在一些特殊的场景中非常有用，例如，kubernetes的pod，kubernetes为pod创建一个基础设施容器，同一pod下的其他容器都以其他容器模式共享这个基础设施容器的网络命名空间，相互之间以localhost访问，构成一个统一的整体。</p>
<h4 id="用户定义网络模式"><a href="#用户定义网络模式" class="headerlink" title="用户定义网络模式"></a>用户定义网络模式</h4><p>在用户定义网络模式下，开发者可以使用任何docker支持的第三方网络driver来定制容器的网络。并且，docker 1.9以上的版本默认自带了bridge和overlay两种类型的自定义网络driver。可以用于集成calico、weave、openvswitch等第三方厂商的网络实现。</p>
<p>除了docker自带的bridge driver，其他的几种driver都可以实现容器的跨主机通信。而基于bdrige driver的网络，docker会自动为其创建iptables规则，保证与其他网络之间、与docker0之间的网络隔离。例如，使用下面的命令创建一个基于bridge driver的自定义网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create bri1</span><br></pre></td></tr></table></figure>
<p>则docker会自动生成如下的iptables规则，保证不同网络上的容器无法互相通信。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-A DOCKER-ISOLATION -i br-8dba6df70456 -o docker0 -j DROP</span><br><span class="line">-A DOCKER-ISOLATION -i docker0 -o br-8dba6df70456 -j DROP</span><br></pre></td></tr></table></figure>
<p>除此之外，bridge driver的所有行为都和默认的bridge模式完全一致。而overlay及其他driver，则可以实现容器的跨主机通信。</p>
<h3 id="docker跨主机容器通信"><a href="#docker跨主机容器通信" class="headerlink" title="docker跨主机容器通信"></a>docker跨主机容器通信</h3><p>早期大家的跨主机通信方案主要有以下几种：</p>
<ul>
<li>容器使用host模式：容器直接使用宿主机的网络，这样天生就可以支持跨主机通信。虽然可以解决跨主机通信问题，但这种方式应用场景很有限，容易出现端口冲突，也无法做到隔离网络环境，一个容器崩溃很可能引起整个宿主机的崩溃。</li>
<li>端口绑定：通过绑定容器端口到宿主机端口，跨主机通信时，使用主机IP+端口的方式访问容器中的服务。显而易见，这种方式仅能支持网络栈的四层及以上的应用，并且容器与宿主机紧耦合，很难灵活的处理，可扩展性不佳。</li>
<li>docker外定制容器网络：在容器通过docker创建完成后，然后再通过修改容器的网络命名空间来定义容器网络。典型的就是很久以前的pipework，容器以none模式创建，pipework通过进入容器的网络命名空间为容器重新配置网络，这样容器网络可以是静态IP、vxlan网络等各种方式，非常灵活，容器启动的一段时间内会没有IP，明显无法在大规模场景下使用，只能在实验室中测试使用。</li>
<li>第三方SDN定义容器网络：使用Open vSwitch或Flannel等第三方SDN工具，为容器构建可以跨主机通信的网络环境。这些方案一般要求各个主机上的docker0网桥的cidr不同，以避免出现IP冲突的问题，限制了容器在宿主机上的可获取IP范围。并且在容器需要对集群外提供服务时，需要比较复杂的配置，对部署实施人员的网络技能要求比较高。</li>
</ul>
<p>上面这些方案有各种各样的缺陷，同时也因为跨主机通信的迫切需求，docker 1.9版本时，官方提出了基于vxlan的overlay网络实现，原生支持容器的跨主机通信。同时，还支持通过libnetwork的plugin机制扩展各种第三方实现，从而以不同的方式实现跨主机通信。就目前社区比较流行的方案来说，跨主机通信的基本实现方案有以下几种：</p>
<ul>
<li>基于隧道的overlay网络：按隧道类型来说，不同的公司或者组织有不同的实现方案。docker原生的overlay网络就是基于vxlan隧道实现的。ovn则需要通过geneve或者stt隧道来实现的。flannel最新版本也开始默认基于vxlan实现overlay网络。</li>
<li>基于包封装的overlay网络：基于UDP封装等数据包包装方式，在docker集群上实现跨主机网络。典型实现方案有weave、flannel的早期版本。</li>
<li>基于三层实现SDN网络：基于三层协议和路由，直接在三层上实现跨主机网络，并且通过iptables实现网络的安全隔离。典型的方案为Project Calico。同时对不支持三层路由的环境，Project Calico还提供了基于IPIP封装的跨主机网络实现。</li>
</ul>
<h2 id="15-1-使用自定义网桥连接跨主机容器"><a href="#15-1-使用自定义网桥连接跨主机容器" class="headerlink" title="15.1 使用自定义网桥连接跨主机容器"></a>15.1 使用自定义网桥连接跨主机容器</h2><ol>
<li>Docker默认的网桥是docker0，它会在本机连接所有的容器</li>
<li><p>自定义网桥连接到主机容器</p>
<ul>
<li><p>2.1 拓扑图</p>
<p><img src="http://cdn.docker.matlabchina.cn/Docker-ch15.1-1.jpg" alt="ch15.1-1"></p>
</li>
<li><p>2.2 创建自己的网桥br0,将物理网卡连接到br0上<br>编辑/etc/network/interface文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">auto br0</span><br><span class="line">iface bro inet static</span><br><span class="line">address 192.168.2.36</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.2.1</span><br><span class="line">bridge_ports enp0s3</span><br><span class="line">brdige_stp off</span><br><span class="line">dns-nameservers 8.8.8.8 192.168.2.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.3 本地修改/etc/deault/docker文件，在最后一行添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=&quot;-b=br0&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>在启动Docker的时候使用<code>-b</code>参数也可以将容器绑定到指定的网桥br0上</p>
</li>
<li>由此，就实现了将容器端口直接暴露到物理网络上，堕胎物理主机的容器通过访问外部映射端口即可相互联网了</li>
</ol>
<h2 id="15-2-使用Ambassador容器"><a href="#15-2-使用Ambassador容器" class="headerlink" title="15.2 使用Ambassador容器"></a>15.2 使用Ambassador容器</h2><ol>
<li>两个Docker容器在同一主机上时，可以通过<code>--link</code>命令让两者相互访问</li>
<li>当两个Docker容器不在同一个主机上时，要实现互联，则往往需要知道其他物理主机的IP地址。而利用Ambassador容器机制，可以让Ambassador容器作为连接代理，实现跨主机连接</li>
</ol>
<h3 id="基本场景"><a href="#基本场景" class="headerlink" title="基本场景"></a>基本场景</h3><ul>
<li><p>原理：</p>
<p>  <img src="http://cdn.docker.matlabchina.cn/Docker-ch15.2-1.PNG" alt="ch15.2-1"></p>
<p>  通过两个Ambassador容器来进行通信代理</p>
</li>
<li>应用：<ul>
<li>创建一个服务端容器redis-server<br><code>sudo docker run -d --name  redis-server crosbymichael/redis</code></li>
<li>创建一个<strong>服务端Ambassador容器</strong>redis_ambassador<br><code>sudo docker run -d -link redis-server:redis --name redis_ambassador -p 6379:6379 svendowideit/ambassador</code></li>
<li>客户端主机上创建<strong>客户端Ambassador容器</strong><br><code>sudo docker run -d -name redis_ambassador -expose 6379 -e REDIS_PORT_6379_TCP=tcp://x.x.x.x:6379 svendowideit/ambassador</code></li>
<li>创建一个客户端容器(默认访问6379端口，实际是访问服务端容器内的redis应用)<br><code>sudo docker run -it -rm -link redis_ambassador:redis relateiq/redis-cli redis 172.17.0.160:6379&gt; ping</code></li>
</ul>
</li>
</ul>
<h2 id="15-3-本章小结"><a href="#15-3-本章小结" class="headerlink" title="15.3 本章小结"></a>15.3 本章小结</h2><ol>
<li>容器的集群管理，主要要实现两个方面的需求：<ul>
<li>容器名称的动态管理</li>
<li>需要底层网络提供灵活的跨主机的支持租户隔离的连接</li>
</ul>
</li>
<li>容器名称的动态管理<br> 即使容器重启，容器内的IP发生变化，利用SkyDNS+SkyDock、etcd、consul等工具来实现容器的DNS系统</li>
<li>底层网络提供灵活的连接<br> 使用Overlay技术。事实上，管理虚拟机的OpenStack等项目提供了相对成熟的基于SDN的网络管理方案。</li>
<li>现在已经有包括Shipyard、Kubernetes等项目实现了一整套的容器集群管理方案</li>
</ol>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2018-01-01T12:41:59.260Z" itemprop="dateUpdated">2018-01-01 20:41:59</time>
</span><br>


        
        No one can guide you, except yourself!     self-link：<a href="/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/" target="_blank" rel="external">http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/</a>
        
    </div>
    <footer>
        <a href="http://matlabchina.cn">
            <img src="/img/logo.jpg" alt="Quincey Svng">
            Quincey Svng
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/&title=《Docker技术入门与实战-第十五章 构建Docker容器集群》 — Quincey&pic=http://matlabchina.cn/img/logo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/&title=《Docker技术入门与实战-第十五章 构建Docker容器集群》 — Quincey&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Docker技术入门与实战-第十五章 构建Docker容器集群》 — Quincey&url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/&via=http://matlabchina.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/01/01/Docker技术入门与实战-第十六章-在公有云上使用Docker/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Docker技术入门与实战-第十六章 在公有云上使用Docker</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/01/01/Docker技术入门与实战-第十四章-使用私有仓库/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Docker技术入门与实战-第十四章 使用私有仓库</h4>
      </a>
    </div>
  
</nav>



    








<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'SuperFireFoxy',
            repo: 'superfirefoxy.github.io',
            oauth: {
                client_id: 'f79ac80faa3d2c58bf61',
                client_secret: '655a9b1df478169a0c1f83cc4cc6b537873db4e3',
            },
        })
        gitment.render('comments')
    </script>
</section>







</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Quincey Svng &copy; 2017 - 2018</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">蜀ICP备16009264号-1</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/&title=《Docker技术入门与实战-第十五章 构建Docker容器集群》 — Quincey&pic=http://matlabchina.cn/img/logo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/&title=《Docker技术入门与实战-第十五章 构建Docker容器集群》 — Quincey&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Docker技术入门与实战-第十五章 构建Docker容器集群》 — Quincey&url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/&via=http://matlabchina.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://matlabchina.cn/2018/01/01/Docker技术入门与实战-第十五章-构建Docker容器集群/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADFElEQVR42u3aQVIjQQwEQP//0+wDYE2VZCKwyDkRMO6ZFIdyS/14xNdHfH2+P1mz/Wt+z+rCxsbGfhP2htEWIlntf/c8L1BuwcbGxr7KTpZ7/qnZb/KsSdZMLNjY2NjYzwMmD7l25dlq2NjY2NjJPcmL5p9qW1TY2NjY2LOWULJtaF9lFlQ/3kvDxsbG/vXsTVvnt/38I/NtbGxs7F/M/iiv/OjMLPA24+FCgY2NjX2InQfA8xK07aQ2eNpCJP8YbGxs7EvsdumkWd+2gfJQzJ8blRUbGxv7EDuPhDbM2u3ELAhXGypsbGzsN2e3r74Z7ibIHLM60IONjY19gt1uPzbz5Da62oM+eRGxsbGxb7M3UfR8ezB8xVHjqR4JYGNjY78te8OYjRM27aS8ZMlzsbGxsW+w88MuSaMn33LkUbc/3PNNbmNjY2OfYG/CJtkq5E3/fJzcHgP6IsCwsbGxT7OT7cf+6ExexLw9FH0WGxsb+xA7OtFTRkW+Wg7OB8D5m2NjY2NfYu/bPe04YXMw6GVtKWxsbOxD7Pxr/atCpX3WZiOEjY2NfZudt+bbO9vBcBtUj82FjY2NfY49G9lumkeborcD4C+ehY2NjX2InexOZk38PORaav6Ub0qPjY2NfYKdNNnbsNkUNLmzLd8X62BjY2MfYuej03wDsBnB5s+aDYyxsbGx77Hzr/v5hmTGaMcAq80MNjY29iF2O1idBdisXZVvP9qhBTY2NvZt9j4kcvCeMWtmYWNjY/819gbWBmR+3CePwG/eGRsbG/sEe/aAOirKT+WNofYIETY2NvZtdjvuzQNj87otLApdbGxs7HPs1z5sE2NtcYcxiY2NjX2C/VFe7fZjdhBzFnVF0bGxsbEPsds20KYQeUy27aHN5gcbGxv7BnsWWvmhnLas7Z3Dd8bGxsY+x27Do20J5UOINthWrSVsbGzsP8xO1nntNiOJsaLNhI2Njf3n2cmByM2BzvaJ9VYHGxsb+xx7dlBmc2c+6M0jqjhmhI2NjX2IPWvNbI5sPi9xO8pty4SNjY19iP0PlPL3E3tP86AAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'woops, lost connnection！';
            clearTimeout(titleTime);
        } else {
            document.title = 'bow, chaka bow boom!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
